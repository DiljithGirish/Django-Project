name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      TF_IN_AUTOMATION: "true"
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
    # ------------------- Checkout -------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ------------------- Code Quality: Python -------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python linting tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Run Black (format check)
      run: black . --check

    - name: Run Flake8 (linting)
      run: flake8 .

    - name: Run isort (import sorting check)
      run: isort . --check-only

    - name: Run Bandit (security check)
      run: bandit -r .

    # ------------------- Code Quality: Terraform ----
    - name: Terraform Format Check
      run: terraform fmt -check -recursive

    # ------------------- Code Quality: Frontend -----
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Node dependencies
      run: |
        cd menu-frontend
        npm ci

    - name: Run ESLint
      run: |
        cd menu-frontend
        npm run lint

    - name: Run Prettier
      run: |
        cd menu-frontend
        npx prettier --check .

    # ------------------- ECR Login -------------------
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    # ------------------- Build & Push Backend --------
    - name: Build backend image
      run: |
        docker build -f Dockerfile.backend \
          -t backend:ci \
          -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/backend-repository:latest .

    - name: Push backend image
      run: |
        docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/backend-repository:latest

    # ------------------- Build & Push Frontend -------
    - name: Build frontend image
      run: |
        docker build -f Dockerfile.frontend \
          -t frontend:ci \
          -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/frontend-repository:latest .

    - name: Push frontend image
      run: |
        docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/frontend-repository:latest

    # ------------------- Terraform Setup & Deploy ----
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.7.5

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Terraform Init
      run: terraform -chdir=terraformfiles init

    - name: Terraform Validate
      run: terraform -chdir=terraformfiles validate

    - name: Terraform Plan
      run: terraform -chdir=terraformfiles plan -out=tfplan

    - name: Terraform Apply
      run: terraform -chdir=terraformfiles apply -auto-approve tfplan

    # ------------------- Print Frontend URL ----------
    - name: Print frontend URL
      run: |
        echo "‚úÖ Application deployed successfully!"
        echo ""
        echo "üåê Frontend URL:"
        terraform -chdir=terraformfiles output -raw frontend_url

